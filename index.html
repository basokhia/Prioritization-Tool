<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Prioritization Framework - 1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F5;
        }
        .tab-active {
            background-color: #607D8B;
            color: #FFFFFF;
            font-weight: 600;
        }
        .tab-inactive {
            background-color: #ECEFF1;
            color: #374151;
        }
        .nav-active {
            border-bottom: 2px solid #607D8B;
            color: #607D8B;
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">

        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Feature Prioritization Framework - 1.0</h1>
            <a href="https://basokhia.github.io/Intake-Hub/" class="text-blue-600 hover:underline mt-2 inline-block">← Back to SSE Intake Hub</a>
        </header>

        <nav class="flex justify-center border-b mb-8">
            <button id="nav-framework" class="py-4 px-6 text-lg nav-active">Calculator</button>
            <button id="nav-backlog" class="py-4 px-6 text-lg text-gray-500">Backlog</button>
            <button id="nav-import" class="py-4 px-6 text-lg text-gray-500">Import from Google Sheet</button>
        </nav>
        
        <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                        <span class="text-2xl">⚠️</span>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Duplicate Check</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="modal-text">A similar feature already exists in the backlog. Do you still want to add this feature?</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="confirm-add-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                            Yes, Add Feature
                        </button>
                        <button id="cancel-add-btn" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <main id="framework-view">
            <section id="calculator" class="bg-white rounded-lg shadow-md p-6 md:p-8">
                <h2 class="text-3xl font-bold text-center mb-2">Interactive Prioritization Calculator</h2>
                <p class="text-center max-w-3xl mx-auto text-gray-600 mb-8">
                    Use this calculator to score a feature based on the framework's criteria. Enter the feature name, select a score for each value driver, estimate the effort, and then save it to the backlog to compare with other items.
                </p>
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="w-full lg:w-1/2">
                        <form id="calculator-form" class="space-y-4">
                             <div>
                                <label for="featureName" class="font-semibold text-gray-700">Feature Name</label>
                                <input type="text" id="featureName" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="Enter a descriptive name">
                            </div>
                            <div>
                                <label for="requestingTeam" class="font-semibold text-gray-700">Requesting Team</label>
                                <select id="requestingTeam" class="w-full mt-1 p-2 border border-gray-300 rounded-md">
                                    <option value="" selected>--- Select a Team ---</option>
                                    <option>Enterprise</option>
                                    <option>QTG Sales</option>
                                    <option>QTG CSS</option>
                                    <option>QTG Marketing</option>
                                    <option>CTC Pre-funding</option>
                                    <option>CTC Post-funding</option>
                                    <option>QTG Engineering</option>
                                    <option>Others</option>
                                </select>
                            </div>
                        </form>
                    </div>
                     <div class="w-full lg:w-1/2 bg-gray-50 rounded-lg p-6 flex flex-col items-center justify-center">
                        <h3 class="text-xl font-semibold mb-4">Calculated Score</h3>
                        <div id="final-score" class="text-7xl font-bold text-[#607D8B]">0.00</div>
                        <div class="text-center mt-4 text-gray-600">
                            <span id="calc-value-score">Value: 0</span> / <span id="calc-effort-score">Effort: N/A</span>
                        </div>
                        <button id="save-to-backlog" class="mt-6 bg-[#607D8B] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#546E7A] transition-colors">
                            Save to Backlog
                        </button>
                    </div>
                </div>
            </section>
        </main>
        
        <main id="backlog-view" class="hidden">
            <section id="backlog-table" class="bg-white rounded-lg shadow-md p-6 md:p-8">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                    <div class="mb-4 sm:mb-0 text-center sm:text-left">
                        <h2 class="text-3xl font-bold">Feature Backlog</h2>
                        <p class="text-gray-600">Your prioritized list of features.</p>
                    </div>
                    <button id="export-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors self-center sm:self-auto hidden">
                        Export to CSV
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b bg-gray-50">
                                <th class="p-3 font-semibold">Priority Score</th>
                                <th class="p-3 font-semibold">Feature Name</th>
                                <th class="p-3 font-semibold">Requesting Team</th>
                                <th class="p-3 font-semibold">Value</th>
                                <th class="p-3 font-semibold">Effort</th>
                                <th class="p-3 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backlog-table-body">
                        </tbody>
                    </table>
                </div>
                 <div id="empty-backlog-message" class="text-center py-12 text-gray-500 hidden">
                    <h3 class="text-xl font-semibold">Your backlog is empty.</h3>
                    <p>Use the calculator to score a feature and save it here.</p>
                </div>
            </section>
        </main>

        <main id="import-view" class="hidden">
            <section id="import-section" class="bg-white rounded-lg shadow-md p-6 md:p-8">
                <h2 class="text-3xl font-bold text-center mb-2">Import from Google Sheet</h2>
                <p class="text-center max-w-3xl mx-auto text-gray-600 mb-8">
                    Bulk-add features by linking a public Google Sheet. The tool will calculate scores for all rows and allow you to add them to your backlog in one click.
                </p>
                
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4">Instructions</h3>
                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                        <li>Create a Google Sheet with the exact column headers below (the order does not matter).</li>
                        <li>Fill in your feature data. Values for criteria must be a number from 0-4. Values for effort must be a T-shirt size (Y, XS, S, M, L, XL).</li>
                        <li>Click <strong>File > Share > Publish to the web</strong>.</li>
                        <li>In the dialog, select "Entire Document" and "Comma-separated values (.csv)". Click "Publish".</li>
                        <li>Copy the generated link and paste it into the input field below.</li>
                    </ol>
                    <div id="required-headers-container" class="mt-4 p-3 bg-gray-200 rounded font-mono text-sm text-gray-800 overflow-x-auto">
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="url" id="google-sheet-url" class="flex-grow w-full p-2 border border-gray-300 rounded-md" placeholder="Paste your published Google Sheet .csv link here">
                    <button id="process-sheet-btn" class="w-full md:w-auto bg-[#607D8B] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#546E7A] transition-colors">
                        Process Sheet
                    </button>
                </div>

                <div id="import-results" class="mt-8 hidden">
                    <h3 class="text-xl font-semibold mb-4">Processing Results</h3>
                    <div id="import-status" class="p-4 rounded-md mb-4"></div>
                    <div id="manual-csv-input-container" class="hidden mt-4">
                        <label for="manual-csv-input" class="block font-semibold text-gray-700 mb-2">Manual CSV Input:</label>
                        <textarea id="manual-csv-input" rows="10" class="w-full p-2 border border-gray-300 rounded-md" placeholder="If automatic fetch failed, open your .csv link in a new tab, copy the text, and paste it here. Then click 'Process Sheet' again."></textarea>
                    </div>
                    <div id="processed-items-preview" class="max-h-96 overflow-y-auto border rounded-lg p-4"></div>
                    <div class="text-center mt-6">
                        <button id="add-all-to-backlog-btn" class="hidden bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors text-lg">
                            Add Items to Backlog
                        </button>
                    </div>
                </div>
            </section>
        </main>

    </div>

    <script>
        const scoreOptions = [
            { text: '--- Select a Score ---', value: 0 },
            { text: '0 - None / Unknown', value: 0 },
            { text: '1 - Low', value: 1 },
            { text: '2 - Medium', value: 2 },
            { text: '3 - High', value: 3 },
            { text: '4 - Very High', value: 4 },
        ];

        const criteriaData = [
            { id: 'lob-okrs', name: 'Alignment to Journey or LOB OKRs', weight: 3 },
            { id: 'team-okrs', name: 'Alignment to Team OKRs', weight: 2 },
            { id: 'sse-okrs', name: 'Alignment to SSE OKRs', weight: 1 },
            { id: 'security', name: 'Security Alignment', weight: 2 },
            { id: 'compliance', name: 'Compliance Alignment', weight: 2 },
            { id: 'urgency', name: 'Urgency', weight: 2 },
            { id: 'revenue-impact', name: 'Expected Revenue Impact', weight: 2 },
            { id: 'opex-savings', name: 'Projected OPEX Savings', weight: 2 },
            { id: 'cx-impact', name: 'Impact to Customer Experience', weight: 2 },
            { id: 'ex-impact', name: 'Impact to Agent/Employee Experience', weight: 1 }
        ];

        const effortData = [
            { rank: 'Y', days: 'Up to 5 days', value: 1 },
            { rank: 'XS', days: '6 - 15 days', value: 2 },
            { rank: 'S', days: '16 - 35 days', value: 3 },
            { rank: 'M', days: '36 - 90 days', value: 5 },
            { rank: 'L', days: '91 - 150 days', value: 8 },
            { rank: 'XL', days: 'Over 150 days', value: 13 }
        ];
        
        let backlog = JSON.parse(localStorage.getItem('featureBacklog')) || [];

        document.addEventListener('DOMContentLoaded', () => {
            const calculatorForm = document.getElementById('calculator-form');
            const saveToBacklogBtn = document.getElementById('save-to-backlog');
            const navFramework = document.getElementById('nav-framework');
            const navBacklog = document.getElementById('nav-backlog');
            const navImport = document.getElementById('nav-import');
            const frameworkView = document.getElementById('framework-view');
            const backlogView = document.getElementById('backlog-view');
            const importView = document.getElementById('import-view');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            
            let processedSheetItems = [];
            
            function switchView(view) {
                frameworkView.classList.add('hidden');
                backlogView.classList.add('hidden');
                importView.classList.add('hidden');
                
                navFramework.classList.remove('nav-active');
                navBacklog.classList.remove('nav-active');
                navImport.classList.remove('nav-active');
                navFramework.classList.add('text-gray-500');
                navBacklog.classList.add('text-gray-500');
                navImport.classList.add('text-gray-500');

                if (view === 'backlog') {
                    backlogView.classList.remove('hidden');
                    navBacklog.classList.add('nav-active');
                    renderBacklog();
                } else if (view === 'import') {
                    importView.classList.remove('hidden');
                    navImport.classList.add('nav-active');
                } else {
                    frameworkView.classList.remove('hidden');
                    navFramework.classList.add('nav-active');
                }
            }
            
            navFramework.addEventListener('click', () => switchView('framework'));
            navBacklog.addEventListener('click', () => switchView('backlog'));
            navImport.addEventListener('click', () => switchView('import'));

            function generateSelect(id, label, weight) {
                let selectHtml = `<div><label for="${id}" class="font-semibold text-gray-700">${label} (x${weight})</label><select id="${id}" name="${id}" class="w-full mt-1 p-2 border border-gray-300 rounded-md">`;
                scoreOptions.forEach(opt => { selectHtml += `<option value="${opt.value}">${opt.text}</option>`; });
                selectHtml += `</select></div>`;
                return selectHtml;
            }

            function populateCalculatorForm() {
                const featureNameDiv = calculatorForm.querySelector('div:first-child');
                const requestingTeamDiv = calculatorForm.querySelector('div:nth-child(2)');
                
                calculatorForm.innerHTML = '';
                calculatorForm.appendChild(featureNameDiv);
                calculatorForm.appendChild(requestingTeamDiv);

                criteriaData.forEach(criterion => {
                    const selectEl = document.createElement('div');
                    selectEl.innerHTML = generateSelect(criterion.id, criterion.name, criterion.weight);
                    calculatorForm.appendChild(selectEl.firstChild);
                });
                
                let effortSelectHtml = `<div><label for="effort" class="font-semibold text-gray-700">Effort Estimation</label><select id="effort" name="effort" class="w-full mt-1 p-2 border border-gray-300 rounded-md">`;
                effortSelectHtml += `<option value="" selected>--- Select Effort ---</option>`;
                effortData.forEach(effort => { effortSelectHtml += `<option value="${effort.value}">${effort.rank} (${effort.days})</option>`; });
                effortSelectHtml += `</select></div>`;
                const effortEl = document.createElement('div');
                effortEl.innerHTML = effortSelectHtml;
                calculatorForm.appendChild(effortEl.firstChild);
            }
            populateCalculatorForm();

            function populateRequiredHeaders() {
                const container = document.getElementById('required-headers-container');
                const headers = ['Feature Name', 'Requesting Team', ...criteriaData.map(c => c.name), 'Effort Estimation'];
                container.innerHTML = `<strong>Required Headers:</strong> ${headers.join(', ')}`;
            }
            populateRequiredHeaders();

            function calculateScore() {
                let valueScore = 0;
                criteriaData.forEach(criterion => { 
                    const el = document.getElementById(criterion.id);
                    if(el) valueScore += parseInt(el.value) * criterion.weight; 
                });
                const effortScoreValue = document.getElementById('effort').value;
                const effortScore = effortScoreValue ? parseInt(effortScoreValue) : 0;
                const finalScore = effortScore > 0 ? (valueScore / effortScore) : 0;

                document.getElementById('final-score').textContent = finalScore.toFixed(2);
                document.getElementById('calc-value-score').textContent = `Value: ${valueScore}`;
                document.getElementById('calc-effort-score').textContent = `Effort: ${effortScore || 'N/A'}`;
                
                return { valueScore, effortScore: effortScoreValue ? parseInt(effortScoreValue) : null, finalScore };
            }

            calculatorForm.addEventListener('change', calculateScore);
            calculatorForm.addEventListener('keyup', calculateScore);

            const modal = document.getElementById('confirmation-modal');
            const confirmBtn = document.getElementById('confirm-add-btn');
            const cancelBtn = document.getElementById('cancel-add-btn');
            const modalText = document.getElementById('modal-text');
            let currentItemToAdd = null;

            function levenshtein(a, b) {
                if(a.length === 0) return b.length; 
                if(b.length === 0) return a.length;
                const matrix = [];
                for(let i = 0; i <= b.length; i++){ matrix[i] = [i]; }
                for(let j = 0; j <= a.length; j++){ matrix[0][j] = j; }
                for(let i = 1; i <= b.length; i++){
                    for(let j = 1; j <= a.length; j++){
                        if(b.charAt(i-1) === a.charAt(j-1)){
                            matrix[i][j] = matrix[i-1][j-1];
                        } else {
                            matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1));
                        }
                    }
                }
                return matrix[b.length][a.length];
            }

            function checkDuplicates(featureName) {
                for(const item of backlog) {
                    const similarity = 1 - (levenshtein(featureName.toLowerCase(), item.name.toLowerCase()) / Math.max(featureName.length, item.name.length));
                    if(similarity > 0.85) {
                        return item;
                    }
                }
                return null;
            }
            
            function addItemToBacklog(item) {
                backlog.push(item);
                localStorage.setItem('featureBacklog', JSON.stringify(backlog));
                alert(`"${item.name}" saved to backlog!`);
                switchView('backlog');
            }

            saveToBacklogBtn.addEventListener('click', () => {
                const featureName = document.getElementById('featureName').value.trim();
                const requestingTeam = document.getElementById('requestingTeam').value;
                if (!featureName) { alert('Please enter a feature name.'); return; }
                if (!requestingTeam) { alert('Please select a requesting team.'); return; }
                const scores = calculateScore();
                if (scores.effortScore === null) { alert('Please select an effort estimation.'); return; }

                const duplicate = checkDuplicates(featureName);
                const effortRank = effortData.find(e => e.value === scores.effortScore).rank;

                currentItemToAdd = {
                    id: Date.now(),
                    name: featureName,
                    team: requestingTeam,
                    valueScore: scores.valueScore,
                    effortScore: scores.effortScore,
                    effortRank: effortRank,
                    priorityScore: scores.finalScore
                };

                if (duplicate) {
                    modalText.textContent = `The feature "${featureName}" is very similar to "${duplicate.name}" which is already in the backlog. Do you still want to add it?`;
                    modal.classList.remove('hidden');
                } else {
                    addItemToBacklog(currentItemToAdd);
                    document.getElementById('calculator-form').reset();
                    calculateScore();
                }
            });

            confirmBtn.addEventListener('click', () => {
                if (currentItemToAdd) {
                    addItemToBacklog(currentItemToAdd);
                    document.getElementById('calculator-form').reset();
                    calculateScore();
                }
                modal.classList.add('hidden');
                currentItemToAdd = null;
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                currentItemToAdd = null;
            });
            
            function renderBacklog() {
                const tableBody = document.getElementById('backlog-table-body');
                const emptyMessage = document.getElementById('empty-backlog-message');
                tableBody.innerHTML = '';
                
                if (backlog.length === 0) {
                    emptyMessage.classList.remove('hidden');
                    exportCsvBtn.classList.add('hidden');
                } else {
                    emptyMessage.classList.add('hidden');
                    exportCsvBtn.classList.remove('hidden');
                    backlog.sort((a, b) => b.priorityScore - a.priorityScore);
                    backlog.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="p-3 font-bold text-lg">${item.priorityScore.toFixed(2)}</td>
                            <td class="p-3">${item.name}</td>
                            <td class="p-3">${item.team || 'N/A'}</td>
                            <td class="p-3">${item.valueScore}</td>
                            <td class="p-3">${item.effortRank} (${item.effortScore})</td>
                            <td class="p-3">
                                <button data-id="${item.id}" class="remove-btn text-red-500 hover:text-red-700 font-semibold">Remove</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            }

            document.getElementById('backlog-table-body').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-btn')) {
                    const itemId = parseInt(e.target.dataset.id);
                    backlog = backlog.filter(item => item.id !== itemId);
                    localStorage.setItem('featureBacklog', JSON.stringify(backlog));
                    renderBacklog();
                }
            });
            
            exportCsvBtn.addEventListener('click', () => {
                if(backlog.length === 0) return;

                const headers = ['Priority Score', 'Feature Name', 'Requesting Team', 'Value Score', 'Effort Score', 'Effort Rank'];
                let csvContent = headers.join(",") + "\r\n";

                const sortedBacklog = [...backlog].sort((a, b) => b.priorityScore - a.priorityScore);

                sortedBacklog.forEach(item => {
                    const name = `"${item.name.replace(/"/g, '""')}"`;
                    const row = [item.priorityScore.toFixed(2), name, item.team, item.valueScore, item.effortScore, item.effortRank];
                    csvContent += row.join(",") + "\r\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "prioritized_backlog.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });

            const processSheetBtn = document.getElementById('process-sheet-btn');
            const sheetUrlInput = document.getElementById('google-sheet-url');
            const importResultsDiv = document.getElementById('import-results');
            const importStatusDiv = document.getElementById('import-status');
            const manualCsvContainer = document.getElementById('manual-csv-input-container');
            const manualCsvInput = document.getElementById('manual-csv-input');
            const previewDiv = document.getElementById('processed-items-preview');
            const addAllBtn = document.getElementById('add-all-to-backlog-btn');

            processSheetBtn.addEventListener('click', async () => {
                const url = sheetUrlInput.value.trim();
                const manualData = manualCsvInput.value.trim();

                if (!url && !manualData) {
                    alert('Please provide a Google Sheet URL or paste CSV data directly.');
                    return;
                }
                
                importResultsDiv.classList.remove('hidden');
                importStatusDiv.className = 'p-4 rounded-md mb-4 bg-yellow-100 text-yellow-800';
                importStatusDiv.textContent = 'Processing...';
                addAllBtn.classList.add('hidden');
                previewDiv.innerHTML = '';
                manualCsvContainer.classList.add('hidden');

                if (manualData) {
                    parseAndProcessCSV(manualData);
                    return;
                }

                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const fetchUrl = `${proxyUrl}${url}`;
                
                try {
                    const response = await fetch(fetchUrl);
                    if (!response.ok) { throw new Error(`Network response was not ok: ${response.statusText}`); }
                    const csvText = await response.text();
                    parseAndProcessCSV(csvText);
                } catch (error) {
                    importStatusDiv.className = 'p-4 rounded-md mb-4 bg-red-100 text-red-800';
                    importStatusDiv.textContent = `Automatic fetch failed: ${error.message}. This can be due to network issues or CORS policies. Please try the manual copy-paste method below.`;
                    manualCsvContainer.classList.remove('hidden');
                }
            });

            function parseAndProcessCSV(csvText) {
                const lines = csvText.split(/\r\n|\n/);
                const headers = lines[0].split(',').map(h => h.trim());
                const requiredHeaders = ['Feature Name', 'Requesting Team', ...criteriaData.map(c => c.name), 'Effort Estimation'];
                
                const missingHeaders = requiredHeaders.filter(rh => !headers.includes(rh));
                if (missingHeaders.length > 0) {
                    importStatusDiv.className = 'p-4 rounded-md mb-4 bg-red-100 text-red-800';
                    importStatusDiv.innerHTML = `<strong>Error: Missing required headers in your Google Sheet.</strong><br>Missing: ${missingHeaders.join(', ')}`;
                    return;
                }

                const headerIndexMap = {};
                requiredHeaders.forEach(rh => headerIndexMap[rh] = headers.indexOf(rh));
                
                processedSheetItems = [];
                let errors = [];
                let duplicates = [];

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const data = lines[i].split(',').map(d => d.trim().replace(/^"|"$/g, ''));
                    try {
                        const featureName = data[headerIndexMap['Feature Name']];
                        const requestingTeam = data[headerIndexMap['Requesting Team']];
                        if (!featureName) continue;

                        const duplicate = checkDuplicates(featureName);
                        if (duplicate) {
                            duplicates.push(`Row ${i + 1}: "${featureName}" is similar to existing backlog item "${duplicate.name}".`);
                            continue;
                        }

                        let valueScore = 0;
                        criteriaData.forEach(criterion => {
                            const score = parseInt(data[headerIndexMap[criterion.name]]);
                            if (isNaN(score) || score < 0 || score > 4) throw new Error(`Invalid score for "${criterion.name}"`);
                            valueScore += score * criterion.weight;
                        });

                        const effortRank = data[headerIndexMap['Effort Estimation']].toUpperCase();
                        const effort = effortData.find(e => e.rank === effortRank);
                        if (!effort) throw new Error(`Invalid Effort Estimation value: "${effortRank}"`);
                        const effortScore = effort.value;
                        
                        const priorityScore = effortScore > 0 ? (valueScore / effortScore) : 0;

                        processedSheetItems.push({
                            id: Date.now() + i,
                            name: featureName,
                            team: requestingTeam,
                            valueScore,
                            effortScore,
                            effortRank,
                            priorityScore
                        });
                    } catch (e) {
                        errors.push(`Row ${i + 1}: ${e.message}`);
                    }
                }
                
                const successCount = processedSheetItems.length;
                const errorCount = errors.length;
                const duplicateCount = duplicates.length;

                if (successCount > 0) {
                    importStatusDiv.className = 'p-4 rounded-md mb-4 bg-green-100 text-green-800';
                    importStatusDiv.textContent = `Processing complete. Successfully calculated scores for ${successCount} new items. Skipped ${errorCount} rows with errors and ${duplicateCount} potential duplicates.`;
                    addAllBtn.textContent = `Add ${successCount} Valid Items to Backlog`;
                    addAllBtn.classList.remove('hidden');
                } else {
                    importStatusDiv.className = 'p-4 rounded-md mb-4 bg-red-100 text-red-800';
                    importStatusDiv.textContent = `Processing failed. Found ${errorCount} errors and ${duplicateCount} duplicates, with no new valid items to import.`;
                    addAllBtn.classList.add('hidden');
                }
                
                let previewHtml = '';
                if (successCount > 0) {
                    previewHtml += '<h4 class="text-lg font-semibold mb-2">Ready to Add:</h4><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2 font-semibold">Score</th><th class="p-2 font-semibold">Feature Name</th><th class="p-2 font-semibold">Team</th></tr></thead><tbody>';
                    processedSheetItems.sort((a,b) => b.priorityScore - a.priorityScore).forEach(item => {
                        previewHtml += `<tr class="border-b"><td class="p-2 font-bold">${item.priorityScore.toFixed(2)}</td><td class="p-2">${item.name}</td><td class="p-2">${item.team}</td></tr>`;
                    });
                    previewHtml += '</tbody></table>';
                }

                if (duplicateCount > 0) {
                    previewHtml += `<h4 class="text-lg font-semibold mt-4 text-yellow-700">Skipped Potential Duplicates (${duplicateCount}):</h4><ul class="list-disc list-inside text-yellow-600">${duplicates.map(d => `<li>${d}</li>`).join('')}</ul>`;
                }

                if (errorCount > 0) {
                    previewHtml += `<h4 class="text-lg font-semibold mt-4 text-red-700">Skipped Rows with Errors (${errorCount}):</h4><ul class="list-disc list-inside text-red-600">${errors.map(e => `<li>${e}</li>`).join('')}</ul>`;
                }
                previewDiv.innerHTML = previewHtml;
            }

            addAllBtn.addEventListener('click', () => {
                backlog = [...backlog, ...processedSheetItems];
                localStorage.setItem('featureBacklog', JSON.stringify(backlog));
                alert(`${processedSheetItems.length} items have been added to the backlog.`);
                sheetUrlInput.value = '';
                importResultsDiv.classList.add('hidden');
                processedSheetItems = [];
                switchView('backlog');
            });

            calculateScore();
        });
    </script>
</body>
</html>

